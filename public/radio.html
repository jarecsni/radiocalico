<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Calico - Live Stream</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Open+Sans:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body {
            font-family: "Open Sans", "Montserrat", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: #FFFFFF;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .header {
            width: 100%;
            background: #231F20;
            padding: 24px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .header .logo {
            width: 60px;
            height: 60px;
        }
        
        .header h1 {
            font-family: "Montserrat", sans-serif;
            font-weight: 700;
            font-size: 2.5rem;
            color: #D8F2D5;
            margin: 0;
            letter-spacing: 0.1em;
        }
        
        .main-content {
            max-width: 1200px;
            width: 100%;
            padding: 48px 24px 0;
            display: flex;
            gap: 48px;
            align-items: flex-start;
        }
        
        .album-section {
            flex: 0 0 400px;
            position: relative;
        }
        
        .track-info-section {
            flex: 1;
            min-width: 0;
        }
        
        .album-art-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        
        .album-art {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        
        .artist-banner {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: #EFA63C;
            color: #FFFFFF;
            padding: 24px;
            text-align: center;
        }
        
        .artist-banner h2 {
            font-family: "Montserrat", sans-serif;
            font-weight: 700;
            font-size: 3rem;
            margin: 0;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        
        
        .track-title {
            font-family: "Montserrat", sans-serif;
            font-weight: 700;
            font-size: 3rem;
            color: #231F20;
            margin: 0 0 16px 0;
            line-height: 1.2;
        }
        
        .song-details {
            margin-bottom: 32px;
        }
        
        .song-title {
            font-family: "Montserrat", sans-serif;
            font-weight: 600;
            font-size: 2rem;
            color: #231F20;
            margin: 0 0 8px 0;
        }
        
        .album-info {
            font-family: "Open Sans", sans-serif;
            font-size: 1.25rem;
            color: #231F20;
            margin: 0 0 24px 0;
        }
        
        .quality-info {
            font-family: "Open Sans", sans-serif;
            font-size: 1rem;
            color: #666;
            margin: 0 0 32px 0;
            font-style: italic;
        }
        
        .audio-controls {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 32px 0;
            max-width: 300px;
        }
        
        .play-button {
            background: none;
            border: none;
            color: #FFFFFF;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        
        .play-icon {
            width: 20px;
            height: 20px;
        }
        
        .play-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .time-display {
            color: #FFFFFF;
            font-family: "Open Sans", sans-serif;
            font-size: 1rem;
            margin-right: 8px;
        }
        
        .volume-icon {
            color: #FFFFFF;
            width: 20px;
            height: 20px;
            margin-left: auto;
        }
        
        .volume-slider {
            width: 100px;
            margin-left: 8px;
        }
        
        .volume-slider {
            height: 4px;
            border-radius: 2px;
            background: #555;
            outline: none;
            -webkit-appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #FFFFFF;
            cursor: pointer;
        }
        
        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #FFFFFF;
            cursor: pointer;
            border: none;
        }
        
        
        .error-message {
            background: #F5EADA;
            color: #231F20;
            padding: 16px;
            border-radius: 4px;
            margin: 32px 0;
            display: none;
            border: 2px solid #EFA63C;
            font-family: "Open Sans", sans-serif;
        }
        
        
        .previous-tracks-section {
            width: 100%;
            background: #D8F2D5;
            margin-top: 64px;
            padding: 48px 0;
        }
        
        .previous-tracks-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }
        
        .previous-tracks-section h3 {
            margin: 0 0 32px 0;
            color: #1F4E23;
            font-size: 2rem;
            font-weight: 600;
            font-family: "Montserrat", sans-serif;
        }
        
        .recent-tracks {
            color: #1F4E23;
            font-size: 16px;
            line-height: 1.8;
        }
        
        .recent-track {
            padding: 8px 0;
        }
        
        .recent-track strong {
            color: #1F4E23;
            font-family: "Montserrat", sans-serif;
            font-weight: 600;
        }
        
        .voting-section {
            margin: 32px 0;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .rate-label {
            font-family: "Open Sans", sans-serif;
            color: #666;
            margin-right: 8px;
        }
        
        .vote-button {
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            transition: transform 0.2s ease;
            padding: 8px;
        }
        
        .vote-button:hover {
            transform: scale(1.1);
        }
        
        .vote-button.liked {
            filter: brightness(1.2);
        }
        
        .vote-button.disliked {
            filter: brightness(1.2);
        }
        
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                gap: 32px;
            }
            
            .album-section {
                flex: none;
                max-width: 400px;
                margin: 0 auto;
            }
            
            .track-title {
                font-size: 2rem;
            }
            
            .song-title {
                font-size: 1.5rem;
            }
        }
        
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <img src="RadioCalicoLogoTM.png" alt="Radio Calico Logo" class="logo">
            <h1>Radio Calico</h1>
        </div>
    </div>
    
    <div class="main-content">
        <div class="album-section">
            <div class="album-art-container">
                <img id="albumArt" class="album-art" src="https://d3d4yli4hf5bmh.cloudfront.net/cover.jpg" alt="Album Art">
                <div class="artist-banner">
                    <h2 id="artistName">SHANDI</h2>
                </div>
            </div>
        </div>
        
        <div class="track-info-section">
            <h1 class="track-title" id="trackTitle">Shandi Sinnamon</h1>
            
            <div class="song-details">
                <h2 class="song-title" id="songTitle">He's A Dream (1983)</h2>
                <div class="album-info" id="albumInfo">Flashdance (Original Motion Picture Soundtrack)</div>
                <div class="quality-info" id="qualityInfo">
                    Source quality: 16-bit 44.1kHz<br>
                    Stream quality: 48kHz FLAC / HLS Lossless
                </div>
            </div>
            
            <div class="voting-section">
                <span class="rate-label">Rate this track:</span>
                <button id="likeButton" class="vote-button" title="Like this song">üëç</button>
                <button id="dislikeButton" class="vote-button" title="Dislike this song">üëé</button>
            </div>
            
            <div class="audio-controls">
                <button id="playButton" class="play-button">
                    <i data-lucide="play" class="play-icon"></i>
                </button>
                <span class="time-display" id="timeDisplay">0:35 / Live</span>
                <i data-lucide="volume-2" class="volume-icon"></i>
                <input type="range" id="volume" class="volume-slider" min="0" max="100" value="50">
            </div>
            
            
            <div id="errorMessage" class="error-message"></div>
        </div>
    </div>
    
    <div class="previous-tracks-section">
        <div class="previous-tracks-container">
            <h3>Previous tracks:</h3>
            <div id="recentTracks" class="recent-tracks">
                Loading recent tracks...
            </div>
        </div>
    </div>
    
    <audio id="audioPlayer" preload="none"></audio>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        class RadioPlayer {
            constructor() {
                this.audio = document.getElementById('audioPlayer');
                this.playButton = document.getElementById('playButton');
                this.volumeSlider = document.getElementById('volume');
                this.errorDiv = document.getElementById('errorMessage');
                this.timeDisplay = document.getElementById('timeDisplay');
                this.recentTracksDiv = document.getElementById('recentTracks');
                this.albumArtImg = document.getElementById('albumArt');
                this.likeButton = document.getElementById('likeButton');
                this.dislikeButton = document.getElementById('dislikeButton');
                this.streamUrl = 'https://d3d4yli4hf5bmh.cloudfront.net/hls/live.m3u8';
                this.metadataUrl = 'https://d3d4yli4hf5bmh.cloudfront.net/metadatav2.json';
                this.hls = null;
                this.isPlaying = false;
                this.startTime = null;
                this.elapsedInterval = null;
                this.metadataInterval = null;
                this.currentSong = null;
                this.userId = this.generateUserId();
                
                this.initializePlayer();
                this.attachEventListeners();
                this.fetchMetadata();
            }
            
            initializePlayer() {
                // Check if HLS is supported
                if (Hls.isSupported()) {
                    this.hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });
                    
                    this.hls.loadSource(this.streamUrl);
                    this.hls.attachMedia(this.audio);
                    
                    this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        console.log('HLS manifest parsed');
                    });
                    
                    this.hls.on(Hls.Events.ERROR, (event, data) => {
                        console.error('HLS Error:', data);
                        this.handleError('Stream error occurred');
                    });
                    
                } else if (this.audio.canPlayType('application/vnd.apple.mpegurl')) {
                    // Safari native HLS support
                    this.audio.src = this.streamUrl;
                } else {
                    this.handleError('HLS is not supported in this browser');
                }
            }
            
            attachEventListeners() {
                this.playButton.addEventListener('click', () => this.togglePlayback());
                
                this.volumeSlider.addEventListener('input', (e) => {
                    this.audio.volume = e.target.value / 100;
                });
                
                this.likeButton.addEventListener('click', () => this.vote(1));
                this.dislikeButton.addEventListener('click', () => this.vote(-1));
                
                
                
                this.audio.addEventListener('playing', () => {
                    this.isPlaying = true;
                    this.playButton.innerHTML = '<i data-lucide="pause" class="play-icon"></i>';
                    lucide.createIcons();
                    this.startElapsedTimer();
                    this.startMetadataPolling();
                });
                
                this.audio.addEventListener('pause', () => {
                    this.isPlaying = false;
                    this.playButton.innerHTML = '<i data-lucide="play" class="play-icon"></i>';
                    lucide.createIcons();
                    this.stopElapsedTimer();
                    this.stopMetadataPolling();
                });
                
                
                this.audio.addEventListener('error', (e) => {
                    console.error('Audio error:', e);
                    this.handleError('Failed to load audio stream');
                });
                
            }
            
            togglePlayback() {
                if (this.isPlaying) {
                    this.audio.pause();
                } else {
                    const playPromise = this.audio.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.error('Playback failed:', error);
                            this.handleError('Playback failed. Click to try again.');
                        });
                    }
                }
            }
            
            handleError(message) {
                this.showError(message);
                this.isPlaying = false;
                this.playButton.innerHTML = '<i data-lucide="play" class="play-icon"></i>';
                lucide.createIcons();
                this.stopElapsedTimer();
                this.stopMetadataPolling();
            }
            
            showError(message) {
                this.errorDiv.textContent = message;
                this.errorDiv.style.display = 'block';
            }
            
            hideError() {
                this.errorDiv.style.display = 'none';
            }
            
            startElapsedTimer() {
                this.startTime = Date.now();
                this.elapsedInterval = setInterval(() => {
                    this.updateElapsedTime();
                }, 1000);
            }
            
            stopElapsedTimer() {
                if (this.elapsedInterval) {
                    clearInterval(this.elapsedInterval);
                    this.elapsedInterval = null;
                }
                if (this.timeDisplay) {
                    this.timeDisplay.textContent = '0:00 / Live';
                }
            }
            
            updateElapsedTime() {
                if (this.startTime && this.timeDisplay) {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    this.timeDisplay.textContent = `${timeString} / Live`;
                }
            }
            
            async fetchMetadata() {
                try {
                    const response = await fetch(this.metadataUrl);
                    const metadata = await response.json();
                    this.updateTrackInfo(metadata);
                    this.updateRecentTracks(metadata);
                    this.updateAlbumArt();
                } catch (error) {
                    console.error('Failed to fetch metadata:', error);
                    this.currentTrackDiv.textContent = 'Track info unavailable';
                    this.recentTracksDiv.textContent = 'Recent tracks unavailable';
                    this.resetVotingUI();
                }
            }
            
            updateTrackInfo(metadata) {
                if (metadata && metadata.artist && metadata.title) {
                    // Update artist name in banner
                    const artistName = document.getElementById('artistName');
                    const trackTitle = document.getElementById('trackTitle');
                    const songTitle = document.getElementById('songTitle');
                    const albumInfo = document.getElementById('albumInfo');
                    const qualityInfo = document.getElementById('qualityInfo');
                    
                    if (artistName) artistName.textContent = metadata.artist.toUpperCase();
                    if (trackTitle) trackTitle.textContent = metadata.artist;
                    if (songTitle) {
                        let titleText = metadata.title;
                        if (metadata.date) {
                            titleText += ` (${metadata.date})`;
                        }
                        songTitle.textContent = titleText;
                    }
                    if (albumInfo && metadata.album) {
                        albumInfo.textContent = metadata.album;
                    }
                    if (qualityInfo && metadata.bit_depth && metadata.sample_rate) {
                        qualityInfo.innerHTML = `Source quality: ${metadata.bit_depth}-bit ${metadata.sample_rate.toLocaleString()}Hz<br>Stream quality: 48kHz FLAC / HLS Lossless`;
                    }
                    
                    // Update voting info if track changed
                    const newSong = {
                        artist: metadata.artist,
                        title: metadata.title,
                        album: metadata.album
                    };
                    
                    const isNewTrack = !this.currentSong || 
                        this.currentSong.artist !== newSong.artist || 
                        this.currentSong.title !== newSong.title;
                    
                    if (isNewTrack) {
                        console.log('New track detected, updating voting info:', newSong);
                        this.currentSong = newSong;
                        this.updateVotingInfo();
                    }
                } else {
                    // Set default values when no track info
                    const artistName = document.getElementById('artistName');
                    const trackTitle = document.getElementById('trackTitle');
                    const songTitle = document.getElementById('songTitle');
                    const albumInfo = document.getElementById('albumInfo');
                    
                    if (artistName) artistName.textContent = 'RADIO CALICO';
                    if (trackTitle) trackTitle.textContent = 'Loading...';
                    if (songTitle) songTitle.textContent = 'Track info unavailable';
                    if (albumInfo) albumInfo.textContent = '';
                    
                    this.currentSong = null;
                    this.resetVotingUI();
                }
            }
            
            updateRecentTracks(metadata) {
                if (!metadata) return;
                
                let recentHtml = '';
                for (let i = 1; i <= 5; i++) {
                    const artist = metadata[`prev_artist_${i}`];
                    const title = metadata[`prev_title_${i}`];
                    
                    if (artist && title) {
                        recentHtml += `
                            <div class="recent-track">
                                <strong>${artist}</strong><br>
                                ${title}
                            </div>
                        `;
                    }
                }
                
                if (recentHtml) {
                    this.recentTracksDiv.innerHTML = recentHtml;
                } else {
                    this.recentTracksDiv.textContent = 'No recent tracks available';
                }
            }
            
            updateAlbumArt() {
                // Force refresh album art by adding timestamp to prevent caching
                const timestamp = Date.now();
                this.albumArtImg.src = `https://d3d4yli4hf5bmh.cloudfront.net/cover.jpg?t=${timestamp}`;
            }
            
            startMetadataPolling() {
                this.metadataInterval = setInterval(() => {
                    this.fetchMetadata();
                }, 30000);
            }
            
            stopMetadataPolling() {
                if (this.metadataInterval) {
                    clearInterval(this.metadataInterval);
                    this.metadataInterval = null;
                }
            }
            
            generateUserId() {
                let userId = localStorage.getItem('radioUserId');
                if (!userId) {
                    userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                    localStorage.setItem('radioUserId', userId);
                }
                return userId;
            }
            
            async updateVotingInfo() {
                if (!this.currentSong) {
                    console.log('No current song, skipping vote info update');
                    return;
                }
                
                console.log('Updating voting info for:', this.currentSong);
                
                try {
                    const response = await fetch('/api/songs/vote-info', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.currentSong)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Vote info received:', data);
                        this.currentSong.songId = data.songId;
                        
                        // Get user's current vote
                        this.getUserVote();
                    } else {
                        console.error('Failed to fetch vote info, status:', response.status);
                    }
                } catch (error) {
                    console.error('Failed to update voting info:', error);
                }
            }
            
            async getUserVote() {
                if (!this.currentSong || !this.currentSong.songId) {
                    console.log('No song ID available for getting user vote');
                    return;
                }
                
                console.log('Getting user vote for song ID:', this.currentSong.songId, 'user:', this.userId);
                
                try {
                    const response = await fetch(`/api/songs/${this.currentSong.songId}/vote/${this.userId}`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('User vote received:', data);
                        this.updateVoteButtons(data.userVote);
                    } else {
                        console.error('Failed to get user vote, status:', response.status);
                    }
                } catch (error) {
                    console.error('Failed to get user vote:', error);
                }
            }
            
            async vote(voteType) {
                if (!this.currentSong || !this.currentSong.songId) return;
                
                try {
                    const response = await fetch(`/api/songs/${this.currentSong.songId}/vote`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: this.userId,
                            voteType: voteType
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.updateVoteButtons(data.userVote);
                    }
                } catch (error) {
                    console.error('Failed to vote:', error);
                }
            }
            
            updateVoteButtons(userVote) {
                this.likeButton.classList.remove('liked');
                this.dislikeButton.classList.remove('disliked');
                
                if (userVote === 1) {
                    this.likeButton.classList.add('liked');
                } else if (userVote === -1) {
                    this.dislikeButton.classList.add('disliked');
                }
            }
            
            resetVotingUI() {
                this.likeButton.classList.remove('liked');
                this.dislikeButton.classList.remove('disliked');
            }
        }
        
        // Initialize the radio player when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new RadioPlayer();
            // Initialize Lucide icons
            lucide.createIcons();
        });
    </script>
</body>
</html>